# Slack UI Routing + Action Panel Fix Design

## Goals and Approach

This change set targets three user-visible behaviors in the Slack UI: the action panel must always appear in the channel timeline, channel-routing advisories must be visible to the channel while remaining owner-only for actions, and the default model should move to `claude-opus-4-6` without breaking existing user settings. The chosen approach is intentionally small and localized to existing pipeline seams: ensure the action panel is rendered immediately after session initialization, move the routing advisory from ephemeral to public posting, and enforce ownership at action-handling time rather than attempting per-user button disabling (which Slack does not support). For action panel visibility, the Slack handler now invokes `ActionPanelManager.ensurePanel` after a successful `SessionInitializer` call, guaranteeing a render even when session initialization completes without other panel updates. For routing advisories, the session initializer posts a public message with routing buttons and then updates that same message to embed an `advisoryTs` value in the action payload, enabling safe cleanup later without risking the user’s original message. Owner-only enforcement happens in the route action handler: non-owners receive an ephemeral warning and the action is ignored. The “현재 채널에서 진행” option is exposed with a default disabled state in the block builder, but explicitly enabled when the flow should allow staying in-channel; the handler routes by creating a new bot thread with the same header, ensuring the conversation continues only in bot-owned threads. Finally, the user settings store’s default model is updated to `claude-opus-4-6`, with a migration that updates legacy default values at load time so existing users are moved forward cleanly.

## Data Flow, Error Handling, and Testing

At runtime, a new message goes through `SlackHandler.handleMessage` → `SessionInitializer.initialize`. If routing is required, the initializer posts a public advisory message in the channel, then updates it with an `advisoryTs`-backed payload so action handlers can delete the advisory safely. Action handlers parse the JSON value, enforce owner identity, and either (a) create a new bot thread in the target channel or (b) create a new bot thread in the current channel when staying. During “stay,” the handler deletes any bot messages from the original thread and terminates the original session key to avoid further dispatch in user-originated threads. The action panel render flow is pushed earlier in the pipeline: once session initialization completes (and routing is not halted), `ActionPanelManager.ensurePanel` renders the panel, using cached render keys to avoid redundant updates and computing disabled state based on activity and in-flight requests. Error handling is explicit: failures to delete the advisory are logged and skipped; missing `advisoryTs` logs a warning instead of deleting the user’s message; non-owner interactions receive ephemeral feedback. Tests cover the new behaviors: a Slack handler test verifies `ensurePanel` is called post-init; routing tests confirm public advisory posting; action handler tests cover owner gating, advisory deletion using `advisoryTs`, and stay-button enablement when allowed; and user settings tests verify migration from legacy opus defaults. Quality gates are enforced via full `npm test`, `npm run lint`, and `npm run build` runs.
